name: ATDX Multi-Platform Build

on:
  push:
    tags:
      - "v*"     # 仅在 tag 触发构建
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # ---------------- WINDOWS ----------------
          - { name: "win-x86",    os: windows-latest, qt_arch: "win32_msvc2019", qt_platform: "windows", msvc_arch: "x86" }
          - { name: "win-x64",    os: windows-latest, qt_arch: "win64_msvc2019_64", qt_platform: "windows", msvc_arch: "x64" }

          # ---------------- LINUX NATIVE ----------------
          - { name: "linux-x64", os: ubuntu-22.04, linux_arch: "x86_64" }
          - { name: "linux-x86", os: ubuntu-22.04, linux_arch: "i386" }

          # ---------------- LINUX ARM CROSS ----------------
          - { name: "linux-armv7", os: ubuntu-22.04, linux_arch: "armhf" }
          - { name: "linux-arm64", os: ubuntu-22.04, linux_arch: "aarch64" }

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ================== 解析 Versions.cmake 生成版本号 ==================
    - name: Generate Version
      shell: bash
      run: |
        VER_MAJOR=$(grep WSJTX_VERSION_MAJOR Versions.cmake | awk '{print $2}')
        VER_MINOR=$(grep WSJTX_VERSION_MINOR Versions.cmake | awk '{print $2}')
        VER_SUB=$(grep WSJTX_VERSION_SUB Versions.cmake | awk '{print $2}')
        VER_RC=$(grep WSJTX_RC Versions.cmake | awk '{print $2}')

        if [ "$VER_RC" != "0" ]; then
          VERSION="${VER_MAJOR}.${VER_MINOR}.${VER_SUB}-rc${VER_RC}"
        else
          VERSION="${VER_MAJOR}.${VER_MINOR}.${VER_SUB}"
        fi

        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Building version: $VERSION"

    # ================= WINDOWS QT INSTALL =================
    - name: Install Qt (Windows only)
      if: matrix.qt_platform == 'windows'
      run: |
        pip install aqtinstall
        aqt install-qt windows desktop 5.15.2 ${{ matrix.qt_arch }} -O C:\Qt
        echo "QT_DIR=C:\Qt\5.15.2\${{ matrix.qt_arch }}" >> $GITHUB_ENV
        git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
        C:\vcpkg\bootstrap-vcpkg.bat
        C:\vcpkg\vcpkg.exe install boost:x64-windows qt5-base qt5-tools qt5-multimedia qt5-serialport qt5-svg qt5-websockets portaudio libusb
        echo "VCPKG_ROOT=C:\vcpkg" >> $GITHUB_ENV

    - name: Setup MSVC + Ninja
      if: matrix.qt_platform == 'windows'
      uses: microsoft/setup-msbuild@v2

    - name: Install Ninja
      if: matrix.qt_platform == 'windows'
      run: |
        Invoke-WebRequest -Uri https://github.com/ninja-build/ninja/releases/download/v1.11.1/ninja-win.zip -OutFile ninja.zip
        Expand-Archive ninja.zip -DestinationPath $Env:USERPROFILE\ninja
        setx PATH "$Env:USERPROFILE\ninja;$Env:PATH"

    # ================= WINDOWS BUILD =================
    - name: Build Windows
      if: matrix.qt_platform == 'windows'
      shell: pwsh
      run: |
        set(CPACK_PACKAGE_NAME "ATDX")
        set(CPACK_PACKAGE_VERSION "${PROJECT_VERSION}")
        set(CPACK_GENERATOR "ZIP;NSIS")
        set(CPACK_PACKAGE_CONTACT "admin@n103.top")
        set(CPACK_PACKAGE_DESCRIPTION_SUMMARY "ATDX - Multi-platform digital mode software")
        cmake -B build -G "Ninja" `
          -DCMAKE_PREFIX_PATH="$env:QT_DIR" `
          -DCPACK_GENERATOR=ZIP `
          -DPROJECT_VERSION=$env:VERSION `
          -DWSJT_SKIP_OMNIRIG=ON

        cmake --build build --config Release
        cpack --config build/CPackConfig.cmake -B dist

    # ================= LINUX DEPENDENCIES =================
    - name: Install Linux build deps
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        sudo tee /etc/apt/sources.list > /dev/null <<'EOF'
        # ================== AMD64 / i386 ==================
        deb [arch=amd64,i386] http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse
        deb [arch=amd64,i386] http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse
        deb [arch=amd64,i386] http://security.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
        deb [arch=amd64,i386] http://archive.ubuntu.com/ubuntu jammy-backports main restricted universe multiverse

        # ================== ARM ==================
        deb [arch=armhf,arm64] http://ports.ubuntu.com/ jammy main restricted universe multiverse
        deb [arch=armhf,arm64] http://ports.ubuntu.com/ jammy-updates main restricted universe multiverse
        deb [arch=armhf,arm64] http://ports.ubuntu.com/ jammy-security main restricted universe multiverse
        deb [arch=armhf,arm64] http://ports.ubuntu.com/ jammy-backports main restricted universe multiverse
        EOF
        sudo dpkg --add-architecture i386 || true
        sudo dpkg --add-architecture armhf || true
        sudo dpkg --add-architecture arm64 || true
        sudo apt update
        sudo apt install -y \
            build-essential cmake git pkg-config \
            qtbase5-dev qttools5-dev qttools5-dev-tools qtmultimedia5-dev \
            libqt5serialport5-dev libqt5svg5-dev libqt5websockets5-dev \
            gfortran libgfortran-11-dev \
            libfftw3-dev libusb-1.0-0-dev libhamlib-dev \
            portaudio19-dev libsamplerate0-dev libasound2-dev \
            libudev-dev libcurl4-openssl-dev \
            libboost-all-dev asciidoctor \
            libhamlib-dev \
            libhamlib-utils

        if [ "${{ matrix.linux_arch }}" = "i386" ]; then
          sudo apt install -y gcc-multilib g++-multilib gfortran-multilib libgfortran-11-dev-i386-cross
          sudo apt install -y \
            build-essential:i386 cmake:i386 git pkg-config \
            qtbase5-dev:i386 qttools5-dev:i386 qttools5-dev-tools:i386 qtmultimedia5-dev:i386 \
            libqt5serialport5-dev:i386 libqt5svg5-dev:i386 libqt5websockets5-dev:i386 \
            gfortran:i386 libgfortran-11-dev:i386 \
            libfftw3-dev:i386 libusb-1.0-0-dev:i386 libhamlib-dev:i386 \
            portaudio19-dev:i386 libsamplerate0-dev:i386 libasound2-dev:i386 \
            libudev-dev:i386 libcurl4-openssl-dev:i386 \
            libboost-all-dev:i386 asciidoctor:i386 \
            libhamlib-dev:i386 \
            libhamlib-utils:i386
        fi

        if [ "${{ matrix.linux_arch }}" = "armhf" ]; then
          sudo apt install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf gfortran-arm-linux-gnueabihf libgfortran-11-dev-armhf-cross
          sudo apt install -y \
            qtbase5-dev:armhf qttools5-dev:armhf qttools5-dev-tools:armhf qtmultimedia5-dev:armhf \
            libqt5serialport5-dev:armhf libqt5svg5-dev:armhf libqt5websockets5-dev:armhf \
            gfortran:armhf libgfortran-11-dev:armhf \
            libfftw3-dev:armhf libusb-1.0-0-dev:armhf libhamlib-dev:armhf \
            portaudio19-dev:armhf libsamplerate0-dev:armhf libasound2-dev:armhf \
            libudev-dev:armhf libcurl4-openssl-dev:armhf \
            libboost-all-dev:armhf asciidoctor:armhf \
            libhamlib-dev:armhf \
            libhamlib-utils:armhf
        fi

        if [ "${{ matrix.linux_arch }}" = "aarch64" ]; then
          sudo apt install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libgfortran-11-dev-arm64-cross gfortran-aarch64-linux-gnu
          sudo apt install -y \
            qtbase5-dev:arm64 qttools5-dev:arm64 qttools5-dev-tools:arm64 qtmultimedia5-dev:arm64 \
            libqt5serialport5-dev:arm64 libqt5svg5-dev:arm64 libqt5websockets5-dev:arm64 \
            gfortran:arm64 libgfortran-11-dev:arm64 \
            libfftw3-dev:arm64 libusb-1.0-0-dev:arm64 libhamlib-dev:arm64 \
            portaudio19-dev:arm64 libsamplerate0-dev:arm64 libasound2-dev:arm64 \
            libudev-dev:arm64 libcurl4-openssl-dev:arm64 \
            libboost-all-dev:arm64 asciidoctor:arm64 \
            libhamlib-dev:arm64 \
            libhamlib-utils:arm64 \
        fi

    # ================= LINUX BUILD =================
    - name: Build Linux
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        if [ "${{ matrix.linux_arch }}" = "i386" ]; then
          export CC=gcc
          export CXX=g++
          export FC=gfortran
          export CFLAGS="-m32"
          export CXXFLAGS="-m32"
          export FFLAGS="-m32"
          export LDFLAGS="-m32"
        fi
        if [ "${{ matrix.linux_arch }}" = "armhf" ]; then
          export CC=arm-linux-gnueabihf-gcc
          export CXX=arm-linux-gnueabihf-g++
          export FC=arm-linux-gnueabihf-gfortran
        fi
        if [ "${{ matrix.linux_arch }}" = "aarch64" ]; then
          export CC=aarch64-linux-gnu-gcc
          export CXX=aarch64-linux-gnu-g++
          export FC=aarch64-linux-gnu-gfortran
        fi

        cmake -B build -DWSJT_SKIP_MANPAGES=ON -DPROJECT_VERSION=$VERSION
        cmake --build build -j$(nproc)
        cpack --config build/CPackConfig.cmake -B dist

    # ================= 上传构建产物 =================
    - name: Upload linux
      if: startsWith(matrix.os, 'ubuntu')
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: |
          dist/*.deb
          dist/*.rpm
  
    - name: Upload windows
      if: startsWith(matrix.os, 'ubuntu')
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: |
          dist/*.zip
          dist/*.exe

  # ================= 创建 Release 并附加所有包 =================
  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release_files

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "ATDX ${{ github.ref_name }}"
        body: "Automated release for version ${{ github.ref_name }}"
        draft: false
        prerelease: false
        files: release_files/**
